<div class="card">
  <p-table #dt [value]="listOrder" [rows]="10" [paginator]="true"
           [globalFilterFields]="['firstname','lastname','address']" [tableStyle]="{'min-width': '75rem'}"
           [rowHover]="true" dataKey="id"
           currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
           [showCurrentPageReport]="true">
    <ng-template pTemplate="caption">
      <div class="flex align-items-center justify-content-between">
        <h5 class="m-0">Quản lý đơn hàng</h5>
        <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                           placeholder="Tìm kiếm"/>`
                </span>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 4rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="name">Họ Tên
          <p-sortIcon field="name"></p-sortIcon>
        </th>

        <th pSortableColumn="address">Địa Chỉ
          <p-sortIcon field="address"></p-sortIcon>
        </th>
        <!-- <th pSortableColumn="town">Town/City <p-sortIcon field="town"></p-sortIcon></th>
        <th pSortableColumn="state">Country/State<p-sortIcon field="state"></p-sortIcon></th> -->
        <!-- <th pSortableColumn="postcode">Postcode/Zip <p-sortIcon field="postcode"></p-sortIcon></th> -->

        <th pSortableColumn="price">Tổng Giá
          <p-sortIcon field="price"></p-sortIcon>
        </th>
        <th pSortableColumn="orderstatus" style="min-width:10rem">Trạng Thái
          <p-sortIcon field="orderstatus"></p-sortIcon>
        </th>

        <th style="min-width:10rem">Thông Tin</th>


      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-order>
      <tr>
        <td style="width: 4rem">
          <p-tableCheckbox [value]="order"></p-tableCheckbox>
        </td>
        <td>{{order.firstname}} {{order.lastname}}</td>

        <td>{{order.address}}</td>

        <td>{{order.totalPrice | currency:'VND'}}</td>
        <!-- <td><button pButton type="button" label={{order.status}} class="p-button-success"></button></td> -->
        <td>
          <button pButton type="button" label="{{order.orderstatus.name}}" [ngClass]="{
                        'waiting-confirm': order.orderstatus.name === 'Chờ Xác Nhận',
                        'waiting-pickup': order.orderstatus.name === 'Chờ Lấy Hàng',
                        'waiting-delivery': order.orderstatus.name === 'Chờ Giao Hàng',
                        'delivered': order.orderstatus.name === 'Đã Giao',
                        'cancelled': order.orderstatus.name === 'Đã Hủy',
                        'returned': order.orderstatus.name === 'Trả Hàng',
                        'system-error': order.orderstatus.name === 'Lỗi Hệ Thống'
                    }"></button>
        </td>


        <td>
          <button
            title="Cập nhật trạng thái đơn hàng"
            *ngIf="![ORDER_STATUS.DONE, ORDER_STATUS.DELIVERED, ORDER_STATUS.CANCELED, ORDER_STATUS.WAITING_CONFIRM_RETURNS, ORDER_STATUS.RETURNS, ORDER_STATUS.REJECT_RETURNS].includes(order.orderstatus.code)"
            pButton pRipple
            icon="pi pi-pencil"
            class="p-button-rounded p-button-primary mr-2" (click)="openUpdate(order)"></button>
          <button *ngIf="order?.orderstatus?.code === ORDER_STATUS.DELIVERED" title="Xác nhận đã nhận được hàng"
                  class="p-button-rounded p-button-success mr-2"
                  pButton
                  pRipple icon="pi pi-verified"
                  (click)="showDialogConfirm(order)"></button>
          <button
            title="Xem chi tiết thông tin trả hàng"
            *ngIf="[ORDER_STATUS.WAITING_CONFIRM_RETURNS, ORDER_STATUS.RETURNS, ORDER_STATUS.REJECT_RETURNS].includes(order.orderstatus.code)"
            pButton pRipple
            icon="pi pi-eye"
            class="p-button-rounded p-button-help mr-2" (click)="showDialogReturn(order)"></button>
          <button title="Chi tiết đơn hàng" pButton pRipple icon="pi pi-search"
                  routerLink="{{routerToOrderDetail}}/{{order.id}}"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog [(visible)]="showFormReturn" [style]="{width: '70vw'}" header="Thông tin chi tiết trả hàng" [modal]="true"
          styleClass="p-fluid">
  <ng-template pTemplate="content">
    <!-- <img [src]="'assets/showcase/images/demo/product/' + product.image" [alt]="product.image" class="product-image" *ngIf="product.image"> -->
    <div class="field">
      <div class="row">
        <div class="col-lg-12">
          <!--        <input type="text" class="form-control" placeholder="Lý do" [(ngModel)]="returnForm.reason"-->
          <!--               name="reason">-->
          <label for="reason">Lý do hoàn trả hàng</label>
          <p-dropdown
            id="reason"
            [options]="reasonOptions"
            [(ngModel)]="reason"
            placeholder="Chọn lý do"
            name="reason"
            [showClear]="true"
            [filter]="true"
            filterBy="label"
            [disabled]="true"
          />
        </div>
      </div>
    </div>
    <p>Hình ảnh trả hàng: </p>
    <div class="d-flex">
      <div *ngFor="let url of imgUrl" class="img">
        <img [src]="url" style="width: 200px; height: 200px; object-fit: cover"/>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <button *ngIf="[ORDER_STATUS.WAITING_CONFIRM_RETURNS].includes(order.orderstatus.code)"
            type="submit" pButton
            (click)="handleReturn('CONFIRM')">Xác nhận
    </button>
    <button *ngIf="[ORDER_STATUS.WAITING_CONFIRM_RETURNS].includes(order.orderstatus.code)"
            type="submit"
            class="p-button-warning" pButton (click)="handleReturn('REJECT')">Từ chối
    </button>
    <button pButton type="button" class="p-button-danger" (click)="closeDialogReturn()">Đóng</button>
  </ng-template>
</p-dialog>


<p-dialog [(visible)]="showForm" [style]="{width: '70vw'}" header="Cập nhật trạng thái đơn hàng" [modal]="true"
          styleClass="p-fluid">
  <ng-template pTemplate="content">
    <!-- <img [src]="'assets/showcase/images/demo/product/' + product.image" [alt]="product.image" class="product-image" *ngIf="product.image"> -->
    <div class="field">
      <label for="email">Mã đơn hàng</label>
      <input disabled="true" type="text" pInputText id="email" [(ngModel)]="productForm.orderCode" required autofocus/>
      <!-- <small class="p-error" *ngIf="submitted && !product.name">Name is required.</small> -->
    </div>
    <div class="field">
      <label class="mb-3">Trạng Thái</label>
      <div class="formgrid grid">
        <div class="field-radiobutton col-6" *ngFor="let orderstatus of liststatus">
          <p-radioButton name="orderstatus" value="{{orderstatus.id}}" [(ngModel)]="productForm.status"
                         [inputId]="orderstatus.id" class="mr-2"></p-radioButton>
          <label [for]="orderstatus.id">{{orderstatus.name}}</label>
        </div>
      </div>
    </div>


  </ng-template>

  <ng-template pTemplate="footer">
    <button type="submit" pButton *ngIf="onUpdate" (click)="updateProduct()">Cập nhật</button>
    <button pButton type="button" class="p-button-danger ml-3" (click)="showForm=false">Đóng</button>
  </ng-template>
</p-dialog>

<p-dialog [header]="'Xác nhận đã nhận được đơn hàng'"
          [(visible)]="visibleDialogConfirm"
          [style]="{width :'50vw'}" [modal]="true"
          [transitionOptions]="'.3s'">
  <div>
    <span class="ml-2">
        Bạn có chắc chắc muốn xác nhận đã nhận được đơn hàng <span>{{ order?.orderCode }}</span> không ?
      </span>
  </div>
  <div class="flex justify-content-end mt-3">
    <button label="Xác nhận" icon="pi pi-check" class="mr-2" pButton (click)="handleConfirm()"></button>
    <button label="Huỷ" icon="pi pi-times" class="p-button-danger" pButton
            (click)="closeDialogConfirm()"></button>
  </div>
</p-dialog>


<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
